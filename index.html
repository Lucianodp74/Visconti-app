// SOLUZIONE 1: Storage pi√π robusto per GitHub Pages
function saveData() {
    try {
        var data = {
            tasks: taskManager.tasks,
            notifications: taskManager.notifications,
            lastSaved: new Date().toISOString()
        };
        
        var jsonData = JSON.stringify(data);
        
        // Prova prima localStorage
        if (typeof Storage !== "undefined" && window.localStorage) {
            localStorage.setItem('gruppoViscontiTasks', jsonData);
            console.log('‚úÖ Dati salvati in localStorage');
            return true;
        }
        
        // Fallback a sessionStorage
        if (typeof Storage !== "undefined" && window.sessionStorage) {
            sessionStorage.setItem('gruppoViscontiTasks', jsonData);
            console.log('‚úÖ Dati salvati in sessionStorage (temporaneo)');
            return true;
        }
        
        // Fallback finale: variabile globale
        window.tempTaskData = data;
        console.log('‚ö†Ô∏è Dati salvati in memoria (si perdono al refresh)');
        return false;
        
    } catch (error) {
        console.error('‚ùå Errore salvataggio:', error);
        
        // Mostra alert pi√π specifico
        showAlert('danger', 'Errore Salvataggio', 
            'Impossibile salvare i dati. I compiti saranno persi al refresh della pagina.');
        
        return false;
    }
}

function loadData() {
    try {
        var savedData = null;
        
        // Prova localStorage
        if (typeof Storage !== "undefined" && window.localStorage) {
            savedData = localStorage.getItem('gruppoViscontiTasks');
        }
        
        // Prova sessionStorage se localStorage fallisce
        if (!savedData && typeof Storage !== "undefined" && window.sessionStorage) {
            savedData = sessionStorage.getItem('gruppoViscontiTasks');
        }
        
        // Prova variabile globale
        if (!savedData && window.tempTaskData) {
            savedData = JSON.stringify(window.tempTaskData);
        }
        
        if (savedData) {
            var data = JSON.parse(savedData);
            taskManager.tasks = data.tasks || [];
            taskManager.notifications = data.notifications || [];
            console.log('‚úÖ Dati caricati: ' + taskManager.tasks.length + ' tasks');
            return true;
        }
        
        console.log('‚ÑπÔ∏è Nessun dato salvato trovato');
        return false;
        
    } catch (error) {
        console.error('‚ùå Errore caricamento:', error);
        taskManager.tasks = [];
        taskManager.notifications = [];
        return false;
    }
}

// SOLUZIONE 2: Debug migliorato per il form
function addTask(event) {
    event.preventDefault();
    
    console.log('üîÑ Tentativo di aggiungere compito...');
    
    var title = document.getElementById('taskTitle').value.trim();
    var description = document.getElementById('taskDescription').value.trim();
    
    console.log('üìù Titolo:', title);
    console.log('üìù Descrizione:', description);
    
    if (!title) {
        console.log('‚ùå Titolo mancante');
        showAlert('danger', 'Errore', 'Inserisci almeno il titolo del compito');
        return;
    }
    
    var assigneeSelect = document.getElementById('taskAssignee');
    var selectedAssignees = [];
    for (var i = 0; i < assigneeSelect.options.length; i++) {
        if (assigneeSelect.options[i].selected) {
            selectedAssignees.push(assigneeSelect.options[i].value);
        }
    }
    
    console.log('üë• Assegnazioni:', selectedAssignees);
    
    if (selectedAssignees.length === 0) {
        console.log('‚ùå Nessun assegnato selezionato');
        showAlert('danger', 'Errore', 'Seleziona almeno un assegnatario');
        return;
    }
    
    var task = {
        id: generateId(),
        title: title,
        description: description,
        assignee: selectedAssignees,
        priority: document.getElementById('taskPriority').value,
        dueDate: document.getElementById('taskDueDate').value,
        status: document.getElementById('taskStatus').value,
        tags: document.getElementById('selectedTags').value ? 
              document.getElementById('selectedTags').value.split(',') : [],
        enableReminder: document.getElementById('enableReminder').checked,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: 'Admin'
    };
    
    console.log('üìã Task creato:', task);
    
    // Aggiungi alla lista
    taskManager.tasks.push(task);
    console.log('üìä Totale tasks:', taskManager.tasks.length);
    
    // Salva immediatamente
    var saved = saveData();
    console.log('üíæ Salvato:', saved);
    
    // Aggiorna interfaccia
    renderCurrentView();
    updateStats();
    
    // Reset form
    document.getElementById('taskForm').reset();
    document.getElementById('selectedTags').value = '';
    
    // Notifica successo
    showAlert('success', 'Compito Aggiunto', 'Il compito "' + title + '" √® stato creato con successo');
    
    console.log('‚úÖ Compito aggiunto con successo');
}

// SOLUZIONE 3: Test diagnostico
function testStorage() {
    console.log('üîç DIAGNOSTICA STORAGE:');
    
    // Test localStorage
    try {
        localStorage.setItem('test', 'ok');
        var result = localStorage.getItem('test');
        localStorage.removeItem('test');
        console.log('‚úÖ localStorage:', result === 'ok' ? 'FUNZIONA' : 'PROBLEMA');
    } catch (e) {
        console.log('‚ùå localStorage:', 'NON DISPONIBILE');
    }
    
    // Test sessionStorage
    try {
        sessionStorage.setItem('test', 'ok');
        var result = sessionStorage.getItem('test');
        sessionStorage.removeItem('test');
        console.log('‚úÖ sessionStorage:', result === 'ok' ? 'FUNZIONA' : 'PROBLEMA');
    } catch (e) {
        console.log('‚ùå sessionStorage:', 'NON DISPONIBILE');
    }
    
    // Informazioni browser
    console.log('üåê URL:', window.location.href);
    console.log('üîí Protocollo:', window.location.protocol);
    console.log('üì± User Agent:', navigator.userAgent.substring(0, 50) + '...');
}

// Aggiungi questa funzione alla console per test
window.testStorage = testStorage;
